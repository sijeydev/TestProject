name: CI
on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: DELETE OLD buildozer.spec
      run: |
        rm -f buildozer.spec
        echo "Старый файл удален"
    
    - uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - run: pip install buildozer cython==0.29.33
    
    - name: Create NEW buildozer.spec
      run: |
        buildozer init
        
        # ПРОВЕРЯЕМ что добавилось
        echo "=== После buildozer init ==="
        grep -n "^\[" buildozer.spec
        
        # ЕСЛИ уже есть [buildozer] - НЕ добавляем
        if grep -q "^\[buildozer\]" buildozer.spec; then
          echo "Секция [buildozer] уже существует, не добавляем"
          # Только меняем настройку
          sed -i '/^\[buildozer\]/,/^\[/ s/^#*android.accept_sdk_license = .*/android.accept_sdk_license = True/' buildozer.spec
        else
          echo "Добавляем секцию [buildozer]"
          echo -e "\n[buildozer]\nandroid.accept_sdk_license = True" >> buildozer.spec
        fi
        
        # ТО ЖЕ САМОЕ для [android]
        if grep -q "^\[android\]" buildozer.spec; then
          echo "Секция [android] уже существует"
          sed -i '/^\[android\]/,/^\[/ s/^#*android.sdk = .*/android.sdk = 34/' buildozer.spec
        else
          echo "Добавляем секцию [android]"
          echo -e "\n[android]\nandroid.sdk = 34" >> buildozer.spec
        fi
        
        echo "=== ФИНАЛЬНЫЙ ВИД ==="
        grep -n "^\[" buildozer.spec
    
    - name: Install Android Build Tools
      run: |
        # ТОЧНО устанавливаем build-tools
        $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager "build-tools;34.0.0" "platform-tools"
    
    - name: Build APK
      run: |
        buildozer -v android debug
        
        if ls bin/*.apk 1> /dev/null 2>&1; then
          echo "✅ APK создан"
          ls bin/*.apk
        else
          echo "❌ APK не найден"
          ls -la bin/ 2>/dev/null || echo "Папка bin не существует"
          exit 1
        fi
    
    - uses: actions/upload-artifact@v4
      with:
        name: apk
        path: bin/*.apk
